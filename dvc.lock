schema: '2.0'
stages:
  standardize_other_products:
    cmd: python src/data/standardize_other_products.py
    deps:
    - path: data/raw/other-trait-maps
      hash: md5
      md5: 224244cf76242106abf656a1946fb350.dir
      size: 28945584053
      nfiles: 1506
    - path: src/data/standardize_other_products.py
      hash: md5
      md5: f0e35e20db15f9c3e94e2e5ee91fec17
      size: 2539
    outs:
    - path: data/interim/other_trait_maps
      hash: md5
      md5: fe0cdb6c19dc0bac2da8766b15c630b7.dir
      size: 499888340
      nfiles: 44
  get_TRY_mean_traits:
    cmd: python src/data/build_try_traits.py
    deps:
    - path: data/raw/TRY_6_gapfilled_for_distribution/TRY6_gapfilled_for_distribution.zip
      hash: md5
      md5: f2cc4a7dd419bed117f42e62780b16e8
      size: 307941318
    - path: src/data/build_try_traits.py
      hash: md5
      md5: 2e3f44bf4e467e6da01e73daf0d1afd1
      size: 3432
    params:
      params.yaml:
        trydb:
          raw:
            dir: TRY_6_gapfilled_for_distribution
            zip: TRY6_gapfilled_for_distribution.zip
            zipfile_csv: TRY6_gapfilled_for_distribution/TRY6_gapfilled_filtered_2.csv.zip
            already_norm:
            - 13
            - 47
            - 95
            - 78
            - 4
            pfts: try_pft_v2.parquet
          interim:
            dir: try
            quantile_range:
            filtered: traits.parquet
    outs:
    - path: data/interim/try/traits.parquet
      hash: md5
      md5: 546b4d12b8c75663f4e07d2a47ad828e
      size: 18025426
  match_gbif_pfts:
    cmd: python src/data/match_gbif_pfts.py
    deps:
    - path: data/raw/all_tracheophyta_non-cult_2024-04-10
      hash: md5
      md5: ada860692d425bd047bd09fd4531fdbf.dir
      size: 30005038638
      nfiles: 1584
    - path: data/raw/try_pft_v2.parquet
      hash: md5
      md5: d49a4b1611eebbd529c9e9aba6aa5f69
      size: 2232209
    - path: src/data/match_gbif_pfts.py
      hash: md5
      md5: 7d1a4ba3531b7f4adfaebae71825792b
      size: 2507
    params:
      params.yaml:
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: gbif
        gbif.interim.matched: gbif_pfts.parquet
        gbif.raw.dir: all_tracheophyta_non-cult_2024-04-10
    outs:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: c2cf56ca2bedf888ff4c99014a82320c.dir
      size: 4473036358
      nfiles: 159
  extract_splot:
    cmd: python src/data/extract_splot.py
    deps:
    - path: data/raw/splot4-0
      hash: md5
      md5: 99990a51d13fe4485f72dd03590d44a6.dir
      size: 521575464
      nfiles: 3
    - path: src/data/extract_splot.py
      hash: md5
      md5: 2a89310e584294f1661965d542a50d18
      size: 3108
    params:
      params.yaml:
        datasets.Y.splot: splot4-0
        splot.interim.dir: splot
    outs:
    - path: data/interim/splot/extracted
      hash: md5
      md5: 79e5388fb25a0c2fa5af8eb08c26498e.dir
      size: 508142149
      nfiles: 3
  harmonize_eo_data:
    cmd: python src/data/harmonize_eo_data.py
    deps:
    - path: src/data/harmonize_eo_data.py
      hash: md5
      md5: d126d484230df9e34370466830219d7e
      size: 7789
    params:
      params.yaml:
        base_resolution: 1000
        datasets.X:
          canopy_height: ETH_GlobalCanopyHeight_2020_v1_1km
          modis: modis_sur_refl_monthly_avg_1km
          soilgrids: soilgrids_v2-0_1km
          vodca: vodca_mean-p5-p95_1km
          worldclim: wc2-1_30s_bio
        eo_data.interim.dir: eo_data
        mask:
          path: data/raw/esa_worldcover_v100_1km/esa_worldcover_v100_1km.tif
          keep_classes:
          - 10
          - 20
          - 30
          - 40
          - 60
          - 70
          - 90
          - 95
          - 100
        model_res: 1km
        target_resolution: 1000
        worldclim.bio_vars:
        - '1'
        - '4'
        - '7'
        - '12'
        - 13-14
        - '15'
    outs:
    - path: data/interim/eo_data/1km
      hash: md5
      md5: f647487e3ff8b6aed0d0c49eac9613be.dir
      size: 30797034288
      nfiles: 150
  build_predict:
    cmd: python src/features/featurize_predict.py
    deps:
    - path: data/interim/eo_data/1km
      hash: md5
      md5: f647487e3ff8b6aed0d0c49eac9613be.dir
      size: 30797034288
      nfiles: 150
    - path: src/features/featurize_predict.py
      hash: md5
      md5: ca3da443b6f09c8a58773d046fa54dca
      size: 5035
    params:
      params.yaml:
        eo_data.interim.dir: eo_data
        eo_data.predict.dir: predict
        eo_data.predict.imputed_fn: eo_predict_imputed.parquet
        eo_data.predict.mask_fn: eo_predict_mask.parquet
        model_res: 1km
        train.dir: data/features
    outs:
    - path: data/features/predict/1km/eo_predict_imputed.parquet
      hash: md5
      md5: 9372b044d0d211e6450b9bee0b772100
      size: 28557279604
    - path: data/features/predict/1km/eo_predict_mask.parquet
      hash: md5
      md5: a5b2d37a18df4f9d1ebcc60484d413d0
      size: 529921831
  build_gbif_maps:
    cmd: python src/data/build_gbif_maps.py
    deps:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: c2cf56ca2bedf888ff4c99014a82320c.dir
      size: 4473036358
      nfiles: 159
    - path: data/interim/try/traits.parquet
      hash: md5
      md5: 546b4d12b8c75663f4e07d2a47ad828e
      size: 18025426
    - path: src/data/build_gbif_maps.py
      hash: md5
      md5: 6099e2c7f230166cab58ad6837852d44
      size: 3682
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: gbif
        model_res: 1km
        target_resolution: 1000
        trydb.interim.dir: try
        trydb.interim.filtered: traits.parquet
    outs:
    - path: data/interim/gbif/trait_maps/Shrub_Tree_Grass/1km
      hash: md5
      md5: 58f3c663a5fc611ada505a202c448aa2.dir
      size: 168341359
      nfiles: 1
  build_splot_maps:
    cmd: python src/data/build_splot_maps.py
    deps:
    - path: data/interim/splot/extracted
      hash: md5
      md5: 79e5388fb25a0c2fa5af8eb08c26498e.dir
      size: 508142149
      nfiles: 3
    - path: data/interim/try/traits.parquet
      hash: md5
      md5: 546b4d12b8c75663f4e07d2a47ad828e
      size: 18025426
    - path: data/raw/try_pft_v2.parquet
      hash: md5
      md5: d49a4b1611eebbd529c9e9aba6aa5f69
      size: 2232209
    - path: src/data/build_splot_maps.py
      hash: md5
      md5: 609ddfc2299ec8e4be2d53e602a3fe91
      size: 8800
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        model_res: 1km
        splot.interim:
          dir: splot
          extracted: extracted
          traits: trait_maps
        target_resolution: 1000
    outs:
    - path: data/interim/splot/trait_maps/Shrub_Tree_Grass/1km
      hash: md5
      md5: 85edd33247000d5637efe2047d5f26d9.dir
      size: 44030841
      nfiles: 1
  build_y:
    cmd: python src/features/build_y.py
    deps:
    - path: data/interim/gbif/trait_maps/Shrub_Tree_Grass/1km
      hash: md5
      md5: 9acfb59cc3a9954d6e908af5f0e89a04.dir
      size: 5608740108
      nfiles: 34
    - path: data/interim/splot/trait_maps/Shrub_Tree_Grass/1km
      hash: md5
      md5: 306c0b8af4e5e43713eb13fd888ca479.dir
      size: 1623776570
      nfiles: 34
    - path: src/features/build_y.py
      hash: md5
      md5: 969480c18cd6001ce1e389a6477e6312
      size: 3007
    params:
      params.yaml:
        datasets.Y.trait_stat: 1
        datasets.Y.traits:
        - 3117
    outs:
    - path: data/features/Shrub_Tree_Grass/1km/Y.parquet
      hash: md5
      md5: 957fe9ca320a21d63fd5ac543c65f75d
      size: 25769252
  calculate_spatial_autocorr:
    cmd: python src/features/calc_spatial_autocorr.py
    deps:
    - path: data/features/Shrub_Tree_Grass/1km/Y.parquet
      hash: md5
      md5: 957fe9ca320a21d63fd5ac543c65f75d
      size: 25769252
    - path: src/features/calc_spatial_autocorr.py
      hash: md5
      md5: 976e85cc5b989395b6dde532c2786531
      size: 12057
    params:
      params.yaml:
        train.spatial_autocorr: spatial_autocorr.parquet
    outs:
    - path: data/features/Shrub_Tree_Grass/1km/spatial_autocorr.parquet
      hash: md5
      md5: 6c449e964aa74b5e22857f571ab0b7ec
      size: 5950
  build_cv_splits:
    cmd: python src/features/skcv_splits.py -o
    deps:
    - path: data/features/Shrub_Tree_Grass/1km/Y.parquet
      hash: md5
      md5: 303853c488a92aa723fc95930d1ae1df
      size: 26349130
    - path: data/features/Shrub_Tree_Grass/1km/spatial_autocorr.parquet
      hash: md5
      md5: 6c449e964aa74b5e22857f571ab0b7ec
      size: 5950
    - path: src/features/skcv_splits.py
      hash: md5
      md5: 85c2af4062f128a52dc82f42e84ca494
      size: 9511
    params:
      params.yaml:
        train.cv_splits:
          range_stat: mean
          n_splits: 5
          n_sims: 100
          dir: skcv_splits
    outs:
    - path: data/features/Shrub_Tree_Grass/1km/skcv_splits
      hash: md5
      md5: 74a1f0729207dd5398829b8352bd2268.dir
      size: 5201084
      nfiles: 1
  train_models:
    cmd: python src/models/train_models.py -r && python src/models/cv_stats.py
    deps:
    - path: data/features/Shrub_Tree_Grass/1km/Y.parquet
      hash: md5
      md5: 303853c488a92aa723fc95930d1ae1df
      size: 26349130
    - path: data/features/Shrub_Tree_Grass/1km/skcv_splits
      hash: md5
      md5: 74a1f0729207dd5398829b8352bd2268.dir
      size: 5201084
      nfiles: 1
    - path: data/features/predict/1km/eo_predict_imputed.parquet
      hash: md5
      md5: 9372b044d0d211e6450b9bee0b772100
      size: 28557279604
    - path: data/features/predict/1km/eo_predict_mask.parquet
      hash: md5
      md5: a5b2d37a18df4f9d1ebcc60484d413d0
      size: 529921831
    - path: src/models/train_models.py
      hash: md5
      md5: 2cdb1448642111361ccb9267d132c598
      size: 1135
    params:
      params.yaml:
        autogluon:
          included_model_types:
          - GBM
          presets: high
          save_bag_folds: true
          refit_full: false
          set_best_to_refit_full: false
          cv_fit_time_limit: 3600
          full_fit_time_limit: 12600
          num_gpus: auto
          num_cpus: 48
          feature_importance: true
          FI_time_limit: 1800
          FI_num_shuffle_sets: 10
        datasets.Y.traits:
        - 11
        train.arch: autogluon
    outs:
    - path: models/Shrub_Tree_Grass/1km
      hash: md5
      md5: a44b55e3bc1a8caf15c5f49118c5bfff.dir
      size: 624708541
      nfiles: 621
  predict:
    cmd: python src/models/predict_traits.py -r -v
    deps:
    - path: data/features/predict/1km/eo_predict_imputed.parquet
      hash: md5
      md5: 9372b044d0d211e6450b9bee0b772100
      size: 28557279604
    - path: data/features/predict/1km/eo_predict_mask.parquet
      hash: md5
      md5: a5b2d37a18df4f9d1ebcc60484d413d0
      size: 529921831
    - path: models/Shrub_Tree_Grass/1km
      hash: md5
      md5: a44b55e3bc1a8caf15c5f49118c5bfff.dir
      size: 624708541
      nfiles: 621
    - path: src/models/predict_traits.py
      hash: md5
      md5: 2d55b55272eb2cc0a23deda34e7d4ae4
      size: 10350
    params:
      params.yaml:
        predict:
          dir: predict
          geos:
            n_workers: 14
            batches: 28
          pylos:
            n_workers: 4
            batches: 24
    outs:
    - path: data/processed/Shrub_Tree_Grass/1km/predict
      hash: md5
      md5: 5cda4b36b3ac8546a552c9acfec23330.dir
      size: 615260362
      nfiles: 2
  aggregate_all_stats:
    cmd: python src/models/multires_stats.py -mfc
    deps:
    - path: models/Shrub_Tree_Grass/1km
      hash: md5
      md5: a44b55e3bc1a8caf15c5f49118c5bfff.dir
      size: 624708541
      nfiles: 621
    - path: src/models/multires_stats.py
      hash: md5
      md5: b55b605d378cfe462ad42108eb6236f1
      size: 11089
    params:
      params.yaml:
        analysis:
          dir: results
          multires_results_fn: all_results.parquet
          multires_fi_fn: all_fi.parquet
