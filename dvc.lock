schema: '2.0'
stages:
  harmonize_eo_data:
    cmd: python src/data/harmonize_eo_data.py -n 12
    deps:
    - path: src/data/harmonize_eo_data.py
      hash: md5
      md5: 0e3caf7e63c91a0ae189efd807abee3b
      size: 7183
    params:
      params.yaml:
        base_resolution: 0.01
        datasets.X:
          canopy_height: ETH_GlobalCanopyHeight_2020_v1_1km
          modis: modis_sur_refl_monthly_avg_1km
          soilgrids: soilgrids_v2-0_1km
          vodca: vodca_mean-p5-p95_1km
          worldclim: wc2-1_30s_bio
        eo_data.interim.dir: eo_data
        mask:
          path: data/raw/esa_worldcover_v100_1km/esa_worldcover_v100_1km.tif
          keep_classes:
          - 10
          - 20
          - 30
          - 40
          - 60
          - 70
          - 90
          - 95
          - 100
        model_res: '001'
        target_resolution: 0.01
        worldclim.bio_vars:
        - '1'
        - '4'
        - '7'
        - '12'
        - 13-14
        - '15'
    outs:
    - path: data/interim/eo_data/001
      hash: md5
      md5: 33b4751370ba70d27e0b170fa13beb54.dir
      size: 34856945252
      nfiles: 150
  extract_splot:
    cmd: python src/data/extract_splot.py
    deps:
    - path: data/raw/splot4-0
      hash: md5
      md5: 99990a51d13fe4485f72dd03590d44a6.dir
      size: 521575464
      nfiles: 3
    - path: src/data/extract_splot.py
      hash: md5
      md5: 2a89310e584294f1661965d542a50d18
      size: 3108
    params:
      params.yaml:
        datasets.Y.splot: splot4-0
        splot.interim.dir: splot
    outs:
    - path: data/interim/splot/extracted
      hash: md5
      md5: cd41e7ce8ca0b67b8dcef9f5d5e3c5ed.dir
      size: 508142149
      nfiles: 3
  match_gbif_pfts:
    cmd: python src/data/match_gbif_pfts.py
    deps:
    - path: data/raw/all_tracheophyta_non-cult_2024-04-10
      hash: md5
      md5: ada860692d425bd047bd09fd4531fdbf.dir
      size: 30005038638
      nfiles: 1584
    - path: data/raw/try_pft_v1.csv
      hash: md5
      md5: c8c8c94250a247ce30b76ce150bedf90
      size: 3964944
    - path: src/data/match_gbif_pfts.py
      hash: md5
      md5: 72e06889328d99142a3df936a895d793
      size: 2105
    params:
      params.yaml:
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: gbif
        gbif.interim.matched: gbif_pfts.parquet
        gbif.raw.dir: all_tracheophyta_non-cult_2024-04-10
    outs:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: 78f983f8785ca9ee69666a4eb7b61c88.dir
      size: 6797540635
      nfiles: 122
  subsample_gbif:
    cmd: python src/data/subsample_gbif.py
    deps:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: 78f983f8785ca9ee69666a4eb7b61c88.dir
      size: 6797540635
      nfiles: 122
    - path: src/data/subsample_gbif.py
      hash: md5
      md5: 73f61cc054c4830e6404dab9a5f08f0e
      size: 2982
    params:
      params.yaml:
        gbif.interim.dir: gbif
        gbif.interim.matched: gbif_pfts.parquet
        gbif.interim.subsample_binsize: 4
        gbif.interim.subsample_n_max: 10000
        gbif.interim.subsampled: gbif_subsampled.parquet
        random_seed: 42
    outs:
    - path: data/interim/gbif/gbif_subsampled.parquet
      hash: md5
      md5: 76716c908063b845b799581377f9ad1c.dir
      size: 905012650
      nfiles: 64
  get_TRY_mean_traits:
    cmd: python src/data/build_try_traits.py
    deps:
    - path: data/raw/TRY_5_GapFilledData_2020/TRY_5_GapFilledData_2020.zip
      hash: md5
      md5: b0b6e84693d252fb89037d45563d7e0e
      size: 452814652
    - path: src/data/build_try_traits.py
      hash: md5
      md5: 0f264e7b766291e81726a062c0858994
      size: 2089
    params:
      params.yaml:
        trydb.interim:
          dir: try
          extracted_csv: mean_gf_bt_sp.csv
          quantile_range:
          - 0.005
          - 0.995
          filtered: mean_gf_bt_sp_filt.parquet
        trydb.raw.dir: TRY_5_GapFilledData_2020
        trydb.raw.zip: TRY_5_GapFilledData_2020.zip
        trydb.raw.zipfile_csv: 
          TRY_50_2020_01/gapfilled_data/mean_gap_filled_back_transformed_incl_species_names.csv
    outs:
    - path: data/interim/try/mean_gf_bt_sp_filt.parquet
      hash: md5
      md5: 9333c1de42af6e722c8d8b4e726a76e7
      size: 13698859
  build_gbif_maps:
    cmd: python src/data/build_gbif_maps.py
    deps:
    - path: data/interim/gbif/gbif_subsampled.parquet
      hash: md5
      md5: 76716c908063b845b799581377f9ad1c.dir
      size: 905012650
      nfiles: 64
    - path: data/interim/try/mean_gf_bt_sp_filt.parquet
      hash: md5
      md5: 9333c1de42af6e722c8d8b4e726a76e7
      size: 13698859
    - path: src/data/build_gbif_maps.py
      hash: md5
      md5: e613bd8f2cab7496116d52ce60e36077
      size: 2193
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: gbif
        gbif.interim.subsampled: gbif_subsampled.parquet
        model_res: '001'
        target_resolution: 0.01
        trydb.interim.dir: try
        trydb.interim.filtered: mean_gf_bt_sp_filt.parquet
    outs:
    - path: data/interim/gbif/trait_maps/Shrub_Tree_Grass/001
      hash: md5
      md5: 499003834d29c5cebcdc7ba44081be40.dir
      size: 7609417391
      nfiles: 33
  build_splot_maps:
    cmd: python src/data/build_splot_maps.py
    deps:
    - path: data/interim/splot/extracted
      hash: md5
      md5: cd41e7ce8ca0b67b8dcef9f5d5e3c5ed.dir
      size: 508142149
      nfiles: 3
    - path: data/interim/try/mean_gf_bt_sp_filt.parquet
      hash: md5
      md5: 9333c1de42af6e722c8d8b4e726a76e7
      size: 13698859
    - path: data/raw/try_pft_v1.csv
      hash: md5
      md5: c8c8c94250a247ce30b76ce150bedf90
      size: 3964944
    - path: src/data/build_splot_maps.py
      hash: md5
      md5: 120dd2ef0cbe3620dbd004be868bf55e
      size: 4482
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        model_res: '001'
        splot.interim:
          dir: splot
          extracted: extracted
          traits: trait_maps
        target_resolution: 0.01
    outs:
    - path: data/interim/splot/trait_maps/Shrub_Tree_Grass/001
      hash: md5
      md5: ce3392f86249ee2ddb4deac861c0f2b5.dir
      size: 1050055399
      nfiles: 33
  calculate_spatial_autocorr:
    cmd: python src/features/calc_spatial_autocorr.py
    deps:
    - path: data/features/Shrub_Tree_Grass/001/Y.parquet
      hash: md5
      md5: 443e6753fa2ed895e5f16b61bd6df385
      size: 1316913887
    - path: src/features/calc_spatial_autocorr.py
      hash: md5
      md5: 24a50475871d60a1fa284add2aa126f3
      size: 6038
    params:
      params.yaml:
        train.spatial_autocorr: spatial_autocorr.parquet
    outs:
    - path: data/features/Shrub_Tree_Grass/001/spatial_autocorr.parquet
      hash: md5
      md5: a4be75634474fa8aa26d2774ca108cc0
      size: 6351
  build_cv_splits:
    cmd: python src/features/skcv_splits.py
    deps:
    - path: data/features/Shrub_Tree_Grass/001/Y.parquet
      hash: md5
      md5: 443e6753fa2ed895e5f16b61bd6df385
      size: 1316913887
    - path: data/features/Shrub_Tree_Grass/001/spatial_autocorr.parquet
      hash: md5
      md5: a4be75634474fa8aa26d2774ca108cc0
      size: 6351
    - path: src/features/skcv_splits.py
      hash: md5
      md5: f1b6b13f4256d7f5093ef845207fc20b
      size: 7176
    params:
      params.yaml:
        train.cv_splits:
          range_stat: median
          n_splits: 5
          n_sims: 100
          dir: skcv_splits
    outs:
    - path: data/features/Shrub_Tree_Grass/001/skcv_splits
      hash: md5
      md5: 50be0b6dfdbc81fd0d7ff0c4643780da.dir
      size: 345848304
      nfiles: 33
  train_models:
    cmd: python src/models/train_models.py -r
    deps:
    - path: data/features/Shrub_Tree_Grass/001/splot_gbif/features.parquet
      hash: md5
      md5: 3ef87f8894e960287439bb2f1bba04e9
      size: 2354976319
    - path: data/features/Shrub_Tree_Grass/001/splot_gbif/skcv_splits
      hash: md5
      md5: efed4bd0061f01f2911c3a0fdf4ecce2.dir
      size: 7374696153
      nfiles: 33
    - path: src/models/train_models.py
      hash: md5
      md5: 8af4db9c9039e2c1b9f81b750c96e228
      size: 1073
    params:
      params.yaml:
        autogluon:
          included_model_types:
          - FASTAI
          - GBM
          - NN_TORCH
          presets: high
          save_bag_folds: true
          refit_full: false
          set_best_to_refit_full: false
          time_limit: 12600
          num_gpus: 4
          feature_importance: true
          FI_time_limit: 3600
          FI_num_shuffle_sets: 10
          leaderboard: leaderboard.csv
        train.arch: autogluon
    outs:
    - path: models/Shrub_Tree_Grass/001/splot_gbif/autogluon
      hash: md5
      md5: 9b4a63ea354a00cccb3f0c90203f637e.dir
      size: 271778692947
      nfiles: 9484
  build_predict:
    cmd: python src/features/featurize_predict.py
    deps:
    - path: data/interim/eo_data/001
      hash: md5
      md5: 33b4751370ba70d27e0b170fa13beb54.dir
      size: 34856945252
      nfiles: 150
    - path: src/features/featurize_predict.py
      hash: md5
      md5: baf07e318781b89bdf67a8ef22992f17
      size: 4432
    params:
      params.yaml:
        eo_data.interim.dir: eo_data
        eo_data.predict.dir: predict
        eo_data.predict.imputed_fn: eo_predict_imputed.parquet
        eo_data.predict.mask_fn: eo_predict_mask.parquet
        model_res: '001'
        train.dir: data/features
    outs:
    - path: data/features/predict/001/eo_predict_imputed.parquet
      hash: md5
      md5: 0d865c4fb80cfb31a2dca600ee87896f
      size: 32491512883
    - path: data/features/predict/001/eo_predict_mask.parquet
      hash: md5
      md5: ccb875cc5b91fa8167876a9e075a3b47
      size: 605125575
  predict:
    cmd: python src/models/predict_traits.py -b 2 -r
    deps:
    - path: data/features/predict/001/eo_predict.parquet
      hash: md5
      md5: 51b833f7798c2ac29fab54cb10b6cce3
      size: 33109670422
    - path: models/Shrub_Tree_Grass/001/splot_gbif/autogluon
      hash: md5
      md5: 9b4a63ea354a00cccb3f0c90203f637e.dir
      size: 271778692947
      nfiles: 9484
    - path: src/models/predict_traits.py
      hash: md5
      md5: d76701cab0173f5edc774db21c44aa19
      size: 5132
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        datasets.Y.use: splot_gbif
        eo_data.predict.dir: predict
        eo_data.predict.filename: eo_predict.parquet
        model_res: '001'
        processed.dir: data/processed
        processed.predict_dir: predict
        train.arch: autogluon
    outs:
    - path: data/processed/Shrub_Tree_Grass/001/splot_gbif/predict
      hash: md5
      md5: 0925e8abb6d4fb4cda8262e90ddb09e1.dir
      size: 21624371949
      nfiles: 33
  splot_corr:
    cmd: python src/analysis/splot_correlation.py -n 4
    deps:
    - path: data/interim/splot/trait_maps/Shrub_Tree_Grass/001
      hash: md5
      md5: ce3392f86249ee2ddb4deac861c0f2b5.dir
      size: 1050055399
      nfiles: 33
    - path: data/processed/Shrub_Tree_Grass/001/splot_gbif/predict
      hash: md5
      md5: 0925e8abb6d4fb4cda8262e90ddb09e1.dir
      size: 21624371949
      nfiles: 33
    - path: src/analysis/splot_correlation.py
      hash: md5
      md5: d56f7a70662c95297e7597837dbaa816
      size: 5433
    outs:
    - path: data/processed/Shrub_Tree_Grass/001/splot_gbif/splot_correlation.csv
      hash: md5
      md5: 2694f64d33dd768064dba52dd5cbaa66
      size: 956
  cov:
    cmd: python src/analysis/cov.py -b 2 -r
    deps:
    - path: data/features/predict/001/eo_predict.parquet
      hash: md5
      md5: 51b833f7798c2ac29fab54cb10b6cce3
      size: 33109670422
    - path: src/analysis/cov.py
      hash: md5
      md5: 6289de056aaf8c444c73cdb5d49e991b
      size: 5137
    params:
      params.yaml:
        target_resolution: 0.01
    outs:
    - path: data/processed/Shrub_Tree_Grass/001/splot_gbif/cov
      hash: md5
      md5: 330d9b51b7b89ee11d427f188a84b416.dir
      size: 22953495610
      nfiles: 33
  build_final_product:
    cmd: python src/data/build_final_product.py
    deps:
    - path: data/processed/Shrub_Tree_Grass/001/splot_gbif/cov
      hash: md5
      md5: 330d9b51b7b89ee11d427f188a84b416.dir
      size: 22953495610
      nfiles: 33
    - path: data/processed/Shrub_Tree_Grass/001/splot_gbif/predict
      hash: md5
      md5: 0925e8abb6d4fb4cda8262e90ddb09e1.dir
      size: 21624371949
      nfiles: 33
    - path: reference/trait_mapping.json
      hash: md5
      md5: aaf617f304ffc9cb990c73cf3a0b4333
      size: 4581
    - path: reference/trait_stat_mapping.json
      hash: md5
      md5: 849cf0970f8069d7351f66056f8c5ff5
      size: 104
    - path: src/data/build_final_product.py
      hash: md5
      md5: ff66238084f2579be5fda84959e6d5ce
      size: 5294
    params:
      params.yaml:
        public.dir: PANOPS/cit-sci-traits/trait_maps
  impute_missing:
    cmd: python src/data/impute_missing.py -c 2
    deps:
    - path: data/features/predict/001/eo_predict.parquet
      hash: md5
      md5: 51b833f7798c2ac29fab54cb10b6cce3
      size: 33109670422
    - path: src/data/impute_missing.py
      hash: md5
      md5: aac28bd1f704e560d965b1e75abac4f3
      size: 1934
    params:
      params.yaml:
        eo_data.imputed:
          dir: imputed
          filename: eo_predict_imputed.parquet
    outs:
    - path: data/interim/eo_data/imputed/eo_predict_imputed.parquet
      hash: md5
      md5: 23ffaa62b5f1a26bcaac6f1244c3d856
      size: 36213051786
  build_y:
    cmd: python src/features/build_y.py
    deps:
    - path: data/interim/gbif/trait_maps/Shrub_Tree_Grass/001
      hash: md5
      md5: 499003834d29c5cebcdc7ba44081be40.dir
      size: 7609417391
      nfiles: 33
    - path: data/interim/splot/trait_maps/Shrub_Tree_Grass/001
      hash: md5
      md5: ce3392f86249ee2ddb4deac861c0f2b5.dir
      size: 1050055399
      nfiles: 33
    - path: src/features/build_y.py
      hash: md5
      md5: 32e5f638dae1b5300a9847d13c9e01db
      size: 2568
    params:
      params.yaml:
        datasets.Y.trait_stat: 1
    outs:
    - path: data/features/Shrub_Tree_Grass/001/Y.parquet
      hash: md5
      md5: 443e6753fa2ed895e5f16b61bd6df385
      size: 1316913887
