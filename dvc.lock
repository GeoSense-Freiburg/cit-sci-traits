schema: '2.0'
stages:
  harmonize_eo_data:
    cmd: python src/data/harmonize_eo_data.py -n 8 -r
    deps:
    - path: src/data/harmonize_eo_data.py
      hash: md5
      md5: c796bb110058808c7cc98cfb474b8b10
      size: 4419
    params:
      params.yaml:
        base_resolution: 0.01
        datasets.X:
        - modis_sur_refl_monthly_avg_1km
        - wc2-1_30s_bio
        eo_data.interim.dir: data/interim/eo_data
        extent:
        - -180
        - -60
        - 180
        - 90
        mask:
          path: data/raw/esa_worldcover_v100_1km/esa_worldcover_v100_1km.tif
          keep_classes:
          - 10
          - 20
          - 30
          - 40
          - 60
          - 70
          - 90
          - 95
          - 100
        model_res: '001'
        target_resolution: 0.01
    outs:
    - path: data/interim/eo_data/001
      hash: md5
      md5: 4e9a7d78d9bcb7b3139a34536a597691.dir
      size: 27006697782
      nfiles: 79
  extract_splot:
    cmd: python src/data/extract_splot.py
    deps:
    - path: data/raw/splot4-0
      hash: md5
      md5: 99990a51d13fe4485f72dd03590d44a6.dir
      size: 521575464
      nfiles: 3
    - path: src/data/extract_splot.py
      hash: md5
      md5: 2f6866ca72aeec62dc646ee33c2056fa
      size: 3044
    params:
      params.yaml:
        datasets.Y.splot: splot4-0
        splot.interim:
          dir: data/interim/splot
    outs:
    - path: data/interim/splot
      hash: md5
      md5: cd41e7ce8ca0b67b8dcef9f5d5e3c5ed.dir
      size: 508142149
      nfiles: 3
  match_gbif_pfts:
    cmd: python src/data/match_gbif_pfts.py
    deps:
    - path: data/raw/all_tracheophyta_non-cult_2024-04-10
      hash: md5
      md5: ada860692d425bd047bd09fd4531fdbf.dir
      size: 30005038638
      nfiles: 1584
    - path: data/raw/try_pft_v1.csv
      hash: md5
      md5: c8c8c94250a247ce30b76ce150bedf90
      size: 3964944
    - path: src/data/match_gbif_pfts.py
      hash: md5
      md5: 8cfb24496175ab83cc97dc9129b4c7d4
      size: 2075
    params:
      params.yaml:
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: data/interim/gbif
        gbif.interim.matched: gbif_pfts.parquet
        gbif.raw.dir: data/raw/all_tracheophyta_non-cult_2024-04-10
    outs:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: 78f983f8785ca9ee69666a4eb7b61c88.dir
      size: 6797540635
      nfiles: 122
  subsample_gbif:
    cmd: python src/data/subsample_gbif.py
    deps:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: 78f983f8785ca9ee69666a4eb7b61c88.dir
      size: 6797540635
      nfiles: 122
    - path: src/data/subsample_gbif.py
      hash: md5
      md5: 23b055d9c55abcf906a6fd3d647a6e95
      size: 2965
    params:
      params.yaml:
        gbif.interim.dir: data/interim/gbif
        gbif.interim.matched: gbif_pfts.parquet
        gbif.interim.subsample_binsize: 4
        gbif.interim.subsample_n_max: 10000
        gbif.interim.subsampled: gbif_subsampled.parquet
    outs:
    - path: data/interim/gbif/gbif_subsampled.parquet
      hash: md5
      md5: 76716c908063b845b799581377f9ad1c.dir
      size: 905012650
      nfiles: 64
  get_TRY_mean_traits:
    cmd: python src/data/build_try_traits.py
    deps:
    - path: data/raw/TRY_5_GapFilledData_2020/TRY_5_GapFilledData_2020.zip
      hash: md5
      md5: b0b6e84693d252fb89037d45563d7e0e
      size: 452814652
    - path: src/data/build_try_traits.py
      hash: md5
      md5: 5c621b6fd81c136dd66da7d8c0ecf250
      size: 2059
    params:
      params.yaml:
        trydb.interim:
          dir: data/interim/try
          extracted_csv: mean_gf_bt_sp.csv
          quantile_range:
          - 0.005
          - 0.995
          filtered: mean_gf_bt_sp_filt.parquet
        trydb.raw.dir: data/raw/TRY_5_GapFilledData_2020
        trydb.raw.zip: TRY_5_GapFilledData_2020.zip
        trydb.raw.zipfile_csv: 
          TRY_50_2020_01/gapfilled_data/mean_gap_filled_back_transformed_incl_species_names.csv
    outs:
    - path: data/interim/try/mean_gf_bt_sp_filt.parquet
      hash: md5
      md5: 9333c1de42af6e722c8d8b4e726a76e7
      size: 13698859
  build_gbif_maps:
    cmd: python src/data/build_gbif_maps.py
    deps:
    - path: data/interim/gbif/gbif_subsampled.parquet
      hash: md5
      md5: 76716c908063b845b799581377f9ad1c.dir
      size: 905012650
      nfiles: 64
    - path: data/interim/try/mean_gf_bt_sp_filt.parquet
      hash: md5
      md5: 9333c1de42af6e722c8d8b4e726a76e7
      size: 13698859
    - path: src/data/build_gbif_maps.py
      hash: md5
      md5: 9b9471bb8da0244fbeeaa4261a40e004
      size: 2118
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: data/interim/gbif
        gbif.interim.subsampled: gbif_subsampled.parquet
        model_res: '001'
        target_resolution: 0.01
        trydb.interim.dir: data/interim/try
        trydb.interim.filtered: mean_gf_bt_sp_filt.parquet
    outs:
    - path: data/processed/traits/Shrub_Tree_Grass/001/gbif
      hash: md5
      md5: 499003834d29c5cebcdc7ba44081be40.dir
      size: 7609417391
      nfiles: 33
