schema: '2.0'
stages:
  get_TRY_mean_traits:
    cmd: python src/data/build_try_traits.py
    deps:
    - path: data/raw/TRY_5_GapFilledData_2020/TRY_5_GapFilledData_2020.zip
      hash: md5
      md5: b0b6e84693d252fb89037d45563d7e0e
      size: 452814652
    - path: src/data/build_try_traits.py
      hash: md5
      md5: 0f264e7b766291e81726a062c0858994
      size: 2089
    params:
      params.yaml:
        trydb.interim:
          dir: try
          extracted_csv: mean_gf_bt_sp.csv
          quantile_range:
          - 0.005
          - 0.995
          filtered: mean_gf_bt_sp_filt.parquet
        trydb.raw.dir: TRY_5_GapFilledData_2020
        trydb.raw.zip: TRY_5_GapFilledData_2020.zip
        trydb.raw.zipfile_csv: 
          TRY_50_2020_01/gapfilled_data/mean_gap_filled_back_transformed_incl_species_names.csv
    outs:
    - path: data/interim/try/mean_gf_bt_sp_filt.parquet
      hash: md5
      md5: 510f410e0fed41ca18b417b0a716dda6
      size: 13698859
  match_gbif_pfts:
    cmd: python src/data/match_gbif_pfts.py
    deps:
    - path: data/raw/all_tracheophyta_non-cult_2024-04-10
      hash: md5
      md5: ada860692d425bd047bd09fd4531fdbf.dir
      size: 30005038638
      nfiles: 1584
    - path: data/raw/try_pft_v1.csv
      hash: md5
      md5: c8c8c94250a247ce30b76ce150bedf90
      size: 3964944
    - path: src/data/match_gbif_pfts.py
      hash: md5
      md5: f1da3d6b45002463dd3722d5dff2c6be
      size: 2118
    params:
      params.yaml:
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: gbif
        gbif.interim.matched: gbif_pfts.parquet
        gbif.raw.dir: all_tracheophyta_non-cult_2024-04-10
    outs:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: 0fa511f0bb36456892bfe3dc7bb35637.dir
      size: 6792826593
      nfiles: 122
  subsample_gbif:
    cmd: python src/data/subsample_gbif.py
    deps:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: 0fa511f0bb36456892bfe3dc7bb35637.dir
      size: 6792826593
      nfiles: 122
    - path: src/data/subsample_gbif.py
      hash: md5
      md5: 73f61cc054c4830e6404dab9a5f08f0e
      size: 2982
    params:
      params.yaml:
        gbif.interim.dir: gbif
        gbif.interim.matched: gbif_pfts.parquet
        gbif.interim.subsample_binsize: 4
        gbif.interim.subsample_n_max: 10000
        gbif.interim.subsampled: gbif_subsampled.parquet
        random_seed: 42
    outs:
    - path: data/interim/gbif/gbif_subsampled.parquet
      hash: md5
      md5: b532b313f20180543b078aa0aa8a90ec.dir
      size: 904490983
      nfiles: 64
  extract_splot:
    cmd: python src/data/extract_splot.py
    deps:
    - path: data/raw/splot4-0
      hash: md5
      md5: 99990a51d13fe4485f72dd03590d44a6.dir
      size: 521575464
      nfiles: 3
    - path: src/data/extract_splot.py
      hash: md5
      md5: 2a89310e584294f1661965d542a50d18
      size: 3108
    params:
      params.yaml:
        datasets.Y.splot: splot4-0
        splot.interim.dir: splot
    outs:
    - path: data/interim/splot/extracted
      hash: md5
      md5: 79e5388fb25a0c2fa5af8eb08c26498e.dir
      size: 508142149
      nfiles: 3
  build_splot_maps:
    cmd: python src/data/build_splot_maps.py
    deps:
    - path: data/interim/splot/extracted
      hash: md5
      md5: 79e5388fb25a0c2fa5af8eb08c26498e.dir
      size: 508142149
      nfiles: 3
    - path: data/interim/try/mean_gf_bt_sp_filt.parquet
      hash: md5
      md5: 510f410e0fed41ca18b417b0a716dda6
      size: 13698859
    - path: data/raw/try_pft_v1.csv
      hash: md5
      md5: c8c8c94250a247ce30b76ce150bedf90
      size: 3964944
    - path: src/data/build_splot_maps.py
      hash: md5
      md5: 1819ec728fdb5b372be5ff932021cdfa
      size: 5620
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        model_res: '2'
        splot.interim:
          dir: splot
          extracted: extracted
          traits: trait_maps
        target_resolution: 2
    outs:
    - path: data/interim/splot/trait_maps/Shrub_Tree_Grass/2
      hash: md5
      md5: 7097f7545f38bb2942cf907342417026.dir
      size: 4839049
      nfiles: 33
  harmonize_eo_data:
    cmd: python src/data/harmonize_eo_data.py
    deps:
    - path: src/data/harmonize_eo_data.py
      hash: md5
      md5: d278ce74489e0e62f7b291a9913c730c
      size: 7524
    params:
      params.yaml:
        base_resolution: 0.01
        datasets.X:
          canopy_height: ETH_GlobalCanopyHeight_2020_v1_1km
          modis: modis_sur_refl_monthly_avg_1km
          soilgrids: soilgrids_v2-0_1km
          vodca: vodca_mean-p5-p95_1km
          worldclim: wc2-1_30s_bio
        eo_data.interim.dir: eo_data
        mask:
          path: data/raw/esa_worldcover_v100_1km/esa_worldcover_v100_1km.tif
          keep_classes:
          - 10
          - 20
          - 30
          - 40
          - 60
          - 70
          - 90
          - 95
          - 100
        model_res: '2'
        target_resolution: 2
        worldclim.bio_vars:
        - '1'
        - '4'
        - '7'
        - '12'
        - 13-14
        - '15'
    outs:
    - path: data/interim/eo_data/2
      hash: md5
      md5: 9bf9ec3a15ccc79fa056fabc614c10df.dir
      size: 2044418
      nfiles: 150
  build_predict:
    cmd: python src/features/featurize_predict.py
    deps:
    - path: data/interim/eo_data/2
      hash: md5
      md5: 9bf9ec3a15ccc79fa056fabc614c10df.dir
      size: 2044418
      nfiles: 150
    - path: src/features/featurize_predict.py
      hash: md5
      md5: dc08fdc5ee733649106d8f2a12602f01
      size: 4447
    params:
      params.yaml:
        eo_data.interim.dir: eo_data
        eo_data.predict.dir: predict
        eo_data.predict.imputed_fn: eo_predict_imputed.parquet
        eo_data.predict.mask_fn: eo_predict_mask.parquet
        model_res: '2'
        train.dir: data/features
    outs:
    - path: data/features/predict/2/eo_predict_imputed.parquet
      hash: md5
      md5: e46dd63282595d7147fd4a505142bd39
      size: 1362686
    - path: data/features/predict/2/eo_predict_mask.parquet
      hash: md5
      md5: ce5d18985f6130a57e8d13afa5325691
      size: 113842
  build_gbif_maps:
    cmd: python src/data/build_gbif_maps.py
    deps:
    - path: data/interim/gbif/gbif_subsampled.parquet
      hash: md5
      md5: b532b313f20180543b078aa0aa8a90ec.dir
      size: 904490983
      nfiles: 64
    - path: data/interim/try/mean_gf_bt_sp_filt.parquet
      hash: md5
      md5: 510f410e0fed41ca18b417b0a716dda6
      size: 13698859
    - path: src/data/build_gbif_maps.py
      hash: md5
      md5: e613bd8f2cab7496116d52ce60e36077
      size: 2193
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: gbif
        gbif.interim.subsampled: gbif_subsampled.parquet
        model_res: '2'
        target_resolution: 2
        trydb.interim.dir: try
        trydb.interim.filtered: mean_gf_bt_sp_filt.parquet
    outs:
    - path: data/interim/gbif/trait_maps/Shrub_Tree_Grass/2
      hash: md5
      md5: 0e0c798a04804494e5e4ce55758d83ea.dir
      size: 9822671
      nfiles: 33
  build_y:
    cmd: python src/features/build_y.py
    deps:
    - path: data/interim/gbif/trait_maps/Shrub_Tree_Grass/2
      hash: md5
      md5: 0e0c798a04804494e5e4ce55758d83ea.dir
      size: 9822671
      nfiles: 33
    - path: data/interim/splot/trait_maps/Shrub_Tree_Grass/2
      hash: md5
      md5: 7097f7545f38bb2942cf907342417026.dir
      size: 4839049
      nfiles: 33
    - path: src/features/build_y.py
      hash: md5
      md5: 0b29a0de1fd27ad9aa9c20691c0a4690
      size: 2578
    params:
      params.yaml:
        datasets.Y.trait_stat: 1
    outs:
    - path: data/features/Shrub_Tree_Grass/2/Y.parquet
      hash: md5
      md5: c5d307847311853052309038a3e397fa
      size: 2465062
  calculate_spatial_autocorr:
    cmd: python src/features/calc_spatial_autocorr.py
    deps:
    - path: data/features/Shrub_Tree_Grass/2/Y.parquet
      hash: md5
      md5: c5d307847311853052309038a3e397fa
      size: 2465062
    - path: src/features/calc_spatial_autocorr.py
      hash: md5
      md5: 3d875417dc61ada871d690ab9d00290b
      size: 8519
    params:
      params.yaml:
        train.spatial_autocorr: spatial_autocorr.parquet
    outs:
    - path: data/features/Shrub_Tree_Grass/2/spatial_autocorr.parquet
      hash: md5
      md5: a4be75634474fa8aa26d2774ca108cc0
      size: 6351
  build_cv_splits:
    cmd: python src/features/skcv_splits.py -o
    deps:
    - path: data/features/Shrub_Tree_Grass/2/Y.parquet
      hash: md5
      md5: c5d307847311853052309038a3e397fa
      size: 2465062
    - path: data/features/Shrub_Tree_Grass/2/spatial_autocorr.parquet
      hash: md5
      md5: a4be75634474fa8aa26d2774ca108cc0
      size: 6351
    - path: src/features/skcv_splits.py
      hash: md5
      md5: 470d31538336d67f729d65a00b40d1dd
      size: 8315
    params:
      params.yaml:
        train.cv_splits:
          range_stat: median
          n_splits: 5
          n_sims: 100
          dir: skcv_splits
    outs:
    - path: data/features/Shrub_Tree_Grass/2/skcv_splits
      hash: md5
      md5: 6c3d1ff4de287e70a15df0fd8459ad52.dir
      size: 273120
      nfiles: 33
  train_models:
    cmd: python src/models/train_models.py -r && python src/models/cv_stats.py
    deps:
    - path: data/features/Shrub_Tree_Grass/2/Y.parquet
      hash: md5
      md5: c5d307847311853052309038a3e397fa
      size: 2465062
    - path: data/features/Shrub_Tree_Grass/2/skcv_splits
      hash: md5
      md5: 6c3d1ff4de287e70a15df0fd8459ad52.dir
      size: 273120
      nfiles: 33
    - path: data/features/predict/2/eo_predict_imputed.parquet
      hash: md5
      md5: e46dd63282595d7147fd4a505142bd39
      size: 1362686
    - path: data/features/predict/2/eo_predict_mask.parquet
      hash: md5
      md5: ce5d18985f6130a57e8d13afa5325691
      size: 113842
    - path: src/models/train_models.py
      hash: md5
      md5: 2cdb1448642111361ccb9267d132c598
      size: 1135
    params:
      params.yaml:
        autogluon:
          included_model_types:
          - GBM
          presets: high
          save_bag_folds: true
          refit_full: false
          set_best_to_refit_full: false
          cv_fit_time_limit: 3600
          full_fit_time_limit: 12600
          num_gpus: auto
          num_cpus: 48
          feature_importance: true
          FI_time_limit: 1800
          FI_num_shuffle_sets: 10
        datasets.Y.traits:
        - 4
        - 6
        - 11
        - 13
        - 14
        - 15
        - 18
        - 21
        - 26
        - 27
        - 46
        - 47
        - 50
        - 55
        - 78
        - 95
        - 138
        - 144
        - 145
        - 146
        - 163
        - 169
        - 223
        - 224
        - 237
        - 281
        - 282
        - 289
        - 1080
        - 3112
        - 3113
        - 3114
        - 3120
        train.arch: autogluon
    outs:
    - path: models/Shrub_Tree_Grass/2
      hash: md5
      md5: 846de530ac9db1a8b54f1b0ff4ee4fb7.dir
      size: 835498949
      nfiles: 18569
  aoa:
    cmd: python src/analysis/aoa.py
    deps:
    - path: data/features/Shrub_Tree_Grass/2/Y.parquet
      hash: md5
      md5: c5d307847311853052309038a3e397fa
      size: 2465062
    - path: data/features/predict/2/eo_predict_imputed.parquet
      hash: md5
      md5: e46dd63282595d7147fd4a505142bd39
      size: 1362686
    - path: models/Shrub_Tree_Grass/2
      hash: md5
      md5: 846de530ac9db1a8b54f1b0ff4ee4fb7.dir
      size: 835498949
      nfiles: 18569
    - path: src/analysis/aoa.py
      hash: md5
      md5: f851f1f0fe263a9c24e48975f766d403
      size: 15663
    params:
      params.yaml:
        aoa:
          dir: aoa
        datasets.Y.traits:
        - 4
        - 6
        - 11
        - 13
        - 14
        - 15
        - 18
        - 21
        - 26
        - 27
        - 46
        - 47
        - 50
        - 55
        - 78
        - 95
        - 138
        - 144
        - 145
        - 146
        - 163
        - 169
        - 223
        - 224
        - 237
        - 281
        - 282
        - 289
        - 1080
        - 3112
        - 3113
        - 3114
        - 3120
    outs:
    - path: data/processed/Shrub_Tree_Grass/2/aoa
      hash: md5
      md5: 5bd022bf8cd667c8cebb97385ac41941.dir
      size: 1072631
      nfiles: 66
  predict:
    cmd: python src/models/predict_traits.py -r
    deps:
    - path: data/features/predict/2/eo_predict_imputed.parquet
      hash: md5
      md5: e46dd63282595d7147fd4a505142bd39
      size: 1362686
    - path: data/features/predict/2/eo_predict_mask.parquet
      hash: md5
      md5: ce5d18985f6130a57e8d13afa5325691
      size: 113842
    - path: models/Shrub_Tree_Grass/2
      hash: md5
      md5: 846de530ac9db1a8b54f1b0ff4ee4fb7.dir
      size: 835498949
      nfiles: 18569
    - path: src/models/predict_traits.py
      hash: md5
      md5: 4cd3bebadcdc862806f4e1c525efaeb8
      size: 10152
    params:
      params.yaml:
        predict:
          dir: predict
          geos:
            n_workers: 14
            batches: 24
          pylos:
            n_workers: 4
            batches: 24
    outs:
    - path: data/processed/Shrub_Tree_Grass/2/predict
      hash: md5
      md5: baebe491ca286165cdee13db6bfe2d24.dir
      size: 1553951
      nfiles: 66
  cov:
    cmd: python src/models/predict_traits.py -r --cov
    deps:
    - path: data/features/predict/2/eo_predict_imputed.parquet
      hash: md5
      md5: e46dd63282595d7147fd4a505142bd39
      size: 1362686
    - path: data/features/predict/2/eo_predict_mask.parquet
      hash: md5
      md5: ce5d18985f6130a57e8d13afa5325691
      size: 113842
    - path: models/Shrub_Tree_Grass/2
      hash: md5
      md5: 846de530ac9db1a8b54f1b0ff4ee4fb7.dir
      size: 835498949
      nfiles: 18569
    - path: src/models/predict_traits.py
      hash: md5
      md5: 4cd3bebadcdc862806f4e1c525efaeb8
      size: 10152
    params:
      params.yaml:
        cov:
          dir: cov
        predict:
          dir: predict
          geos:
            n_workers: 14
            batches: 24
          pylos:
            n_workers: 4
            batches: 24
    outs:
    - path: data/processed/Shrub_Tree_Grass/2/cov
      hash: md5
      md5: 562c67c6c055ce6b8404f76ec5e4620d.dir
      size: 1593945
      nfiles: 66
  aggregate_all_stats:
    cmd: python src/models/multires_stats.py -mfc
    deps:
    - path: models/Shrub_Tree_Grass/2
      hash: md5
      md5: 846de530ac9db1a8b54f1b0ff4ee4fb7.dir
      size: 835498949
      nfiles: 18569
    - path: src/models/multires_stats.py
      hash: md5
      md5: 1cbd3da7132cb0ebd1725ed78915a2fc
      size: 10906
    params:
      params.yaml:
        analysis:
          dir: results
          multires_results_fn: all_results.parquet
          multires_fi_fn: all_fi.parquet

  standardize_other_products:
    cmd: python src/data/standardize_other_products.py
    deps:
    - path: data/raw/other-trait-maps
      hash: md5
      md5: 224244cf76242106abf656a1946fb350.dir
      size: 28945584053
      nfiles: 1506
    - path: src/data/standardize_other_products.py
      hash: md5
      md5: f0e35e20db15f9c3e94e2e5ee91fec17
      size: 2539
    outs:
    - path: data/interim/other_trait_maps
      hash: md5
      md5: fe0cdb6c19dc0bac2da8766b15c630b7.dir
      size: 499888340
      nfiles: 44
