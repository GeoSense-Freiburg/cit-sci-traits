schema: '2.0'
stages:
  get_TRY_mean_traits:
    cmd: python src/data/build_try_traits.py
    deps:
    - path: data/raw/TRY_5_GapFilledData_2020/TRY_5_GapFilledData_2020.zip
      hash: md5
      md5: b0b6e84693d252fb89037d45563d7e0e
      size: 452814652
    - path: src/data/build_try_traits.py
      hash: md5
      md5: 0f264e7b766291e81726a062c0858994
      size: 2089
    params:
      params.yaml:
        trydb.interim:
          dir: try
          extracted_csv: mean_gf_bt_sp.csv
          quantile_range:
          - 0.005
          - 0.995
          filtered: mean_gf_bt_sp_filt.parquet
        trydb.raw.dir: TRY_5_GapFilledData_2020
        trydb.raw.zip: TRY_5_GapFilledData_2020.zip
        trydb.raw.zipfile_csv: 
          TRY_50_2020_01/gapfilled_data/mean_gap_filled_back_transformed_incl_species_names.csv
    outs:
    - path: data/interim/try/mean_gf_bt_sp_filt.parquet
      hash: md5
      md5: 510f410e0fed41ca18b417b0a716dda6
      size: 13698859
  match_gbif_pfts:
    cmd: python src/data/match_gbif_pfts.py
    deps:
    - path: data/raw/all_tracheophyta_non-cult_2024-04-10
      hash: md5
      md5: ada860692d425bd047bd09fd4531fdbf.dir
      size: 30005038638
      nfiles: 1584
    - path: data/raw/try_pft_v1.csv
      hash: md5
      md5: c8c8c94250a247ce30b76ce150bedf90
      size: 3964944
    - path: src/data/match_gbif_pfts.py
      hash: md5
      md5: d46c0f918ff0aa9bf84e0f7829d95ca0
      size: 2220
    params:
      params.yaml:
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: gbif
        gbif.interim.matched: gbif_pfts.parquet
        gbif.raw.dir: all_tracheophyta_non-cult_2024-04-10
    outs:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: 808425a21170d42c6f1c9078555864eb.dir
      size: 4474658309
      nfiles: 159
  subsample_gbif:
    cmd: python src/data/subsample_gbif.py
    deps:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: 0fa511f0bb36456892bfe3dc7bb35637.dir
      size: 6792826593
      nfiles: 122
    - path: src/data/subsample_gbif.py
      hash: md5
      md5: 73f61cc054c4830e6404dab9a5f08f0e
      size: 2982
    params:
      params.yaml:
        gbif.interim.dir: gbif
        gbif.interim.matched: gbif_pfts.parquet
        gbif.interim.subsample_binsize: 4
        gbif.interim.subsample_n_max: 10000
        gbif.interim.subsampled: gbif_subsampled.parquet
        random_seed: 42
    outs:
    - path: data/interim/gbif/gbif_subsampled.parquet
      hash: md5
      md5: b532b313f20180543b078aa0aa8a90ec.dir
      size: 904490983
      nfiles: 64
  extract_splot:
    cmd: python src/data/extract_splot.py
    deps:
    - path: data/raw/splot4-0
      hash: md5
      md5: 99990a51d13fe4485f72dd03590d44a6.dir
      size: 521575464
      nfiles: 3
    - path: src/data/extract_splot.py
      hash: md5
      md5: 2a89310e584294f1661965d542a50d18
      size: 3108
    params:
      params.yaml:
        datasets.Y.splot: splot4-0
        splot.interim.dir: splot
    outs:
    - path: data/interim/splot/extracted
      hash: md5
      md5: 79e5388fb25a0c2fa5af8eb08c26498e.dir
      size: 508142149
      nfiles: 3
  harmonize_eo_data:
    cmd: python src/data/harmonize_eo_data.py
    deps:
    - path: src/data/harmonize_eo_data.py
      hash: md5
      md5: d126d484230df9e34370466830219d7e
      size: 7789
    params:
      params.yaml:
        base_resolution: 1000
        datasets.X:
          canopy_height: ETH_GlobalCanopyHeight_2020_v1_1km
          modis: modis_sur_refl_monthly_avg_1km
          soilgrids: soilgrids_v2-0_1km
          vodca: vodca_mean-p5-p95_1km
          worldclim: wc2-1_30s_bio
        eo_data.interim.dir: eo_data
        mask:
          path: data/raw/esa_worldcover_v100_1km/esa_worldcover_v100_1km.tif
          keep_classes:
          - 10
          - 20
          - 30
          - 40
          - 60
          - 70
          - 90
          - 95
          - 100
        model_res: 1km
        target_resolution: 1000
        worldclim.bio_vars:
        - '1'
        - '4'
        - '7'
        - '12'
        - 13-14
        - '15'
    outs:
    - path: data/interim/eo_data/1km
      hash: md5
      md5: f647487e3ff8b6aed0d0c49eac9613be.dir
      size: 30797034288
      nfiles: 150
  build_predict:
    cmd: python src/features/featurize_predict.py
    deps:
    - path: data/interim/eo_data/1km
      hash: md5
      md5: f647487e3ff8b6aed0d0c49eac9613be.dir
      size: 30797034288
      nfiles: 150
    - path: src/features/featurize_predict.py
      hash: md5
      md5: ca3da443b6f09c8a58773d046fa54dca
      size: 5035
    params:
      params.yaml:
        eo_data.interim.dir: eo_data
        eo_data.predict.dir: predict
        eo_data.predict.imputed_fn: eo_predict_imputed.parquet
        eo_data.predict.mask_fn: eo_predict_mask.parquet
        model_res: 1km
        train.dir: data/features
    outs:
    - path: data/features/predict/1km/eo_predict_imputed.parquet
      hash: md5
      md5: 9372b044d0d211e6450b9bee0b772100
      size: 28557279604
    - path: data/features/predict/1km/eo_predict_mask.parquet
      hash: md5
      md5: a5b2d37a18df4f9d1ebcc60484d413d0
      size: 529921831
  build_gbif_maps:
    cmd: python src/data/build_gbif_maps.py
    deps:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: 808425a21170d42c6f1c9078555864eb.dir
      size: 4474658309
      nfiles: 159
    - path: data/interim/try/mean_gf_bt_sp_filt.parquet
      hash: md5
      md5: 510f410e0fed41ca18b417b0a716dda6
      size: 13698859
    - path: src/data/build_gbif_maps.py
      hash: md5
      md5: 19edc0efc9486d540b3f6f2fb369c801
      size: 3347
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: gbif
        model_res: 1km
        target_resolution: 1000
        trydb.interim.dir: try
        trydb.interim.filtered: mean_gf_bt_sp_filt.parquet
    outs:
    - path: data/interim/gbif/trait_maps/Shrub_Tree_Grass/1km
      hash: md5
      md5: 914376449de97ddb139e94e5ac69f8d8.dir
      size: 5440398749
      nfiles: 33
  build_splot_maps:
    cmd: python src/data/build_splot_maps.py
    deps:
    - path: data/interim/splot/extracted
      hash: md5
      md5: 79e5388fb25a0c2fa5af8eb08c26498e.dir
      size: 508142149
      nfiles: 3
    - path: data/interim/try/mean_gf_bt_sp_filt.parquet
      hash: md5
      md5: 510f410e0fed41ca18b417b0a716dda6
      size: 13698859
    - path: data/raw/try_pft_v1.csv
      hash: md5
      md5: c8c8c94250a247ce30b76ce150bedf90
      size: 3964944
    - path: src/data/build_splot_maps.py
      hash: md5
      md5: 760990bb0b6487cd657aad94ecca6252
      size: 8251
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        model_res: 1km
        splot.interim:
          dir: splot
          extracted: extracted
          traits: trait_maps
        target_resolution: 1000
    outs:
    - path: data/interim/splot/trait_maps/Shrub_Tree_Grass/1km
      hash: md5
      md5: a2992451d4a0ee7dfe5b4cbd778bafe3.dir
      size: 1579745561
      nfiles: 33
  build_y:
    cmd: python src/features/build_y.py
    deps:
    - path: data/interim/gbif/trait_maps/Shrub_Tree_Grass/1km
      hash: md5
      md5: 914376449de97ddb139e94e5ac69f8d8.dir
      size: 5440398749
      nfiles: 33
    - path: data/interim/splot/trait_maps/Shrub_Tree_Grass/1km
      hash: md5
      md5: a2992451d4a0ee7dfe5b4cbd778bafe3.dir
      size: 1579745561
      nfiles: 33
    - path: src/features/build_y.py
      hash: md5
      md5: be8d0de566b38a1500468b27d9f7d291
      size: 3043
    params:
      params.yaml:
        datasets.Y.trait_stat: 1
        datasets.Y.traits:
        - 11
    outs:
    - path: data/features/Shrub_Tree_Grass/1km/Y.parquet
      hash: md5
      md5: 303853c488a92aa723fc95930d1ae1df
      size: 26349130

  standardize_other_products:
    cmd: python src/data/standardize_other_products.py
    deps:
    - path: data/raw/other-trait-maps
      hash: md5
      md5: 224244cf76242106abf656a1946fb350.dir
      size: 28945584053
      nfiles: 1506
    - path: src/data/standardize_other_products.py
      hash: md5
      md5: f0e35e20db15f9c3e94e2e5ee91fec17
      size: 2539
    outs:
    - path: data/interim/other_trait_maps
      hash: md5
      md5: fe0cdb6c19dc0bac2da8766b15c630b7.dir
      size: 499888340
      nfiles: 44
